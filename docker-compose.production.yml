version: '3.9'

services:
  # ============================================================================
  # AINEON Flash Loan Engine - Main Service
  # ============================================================================
  aineon-flashloan:
    container_name: aineon-engine-prod
    image: aineon-flashloan:latest
    build:
      context: .
      dockerfile: Dockerfile.production
    
    # Restart policy
    restart: unless-stopped
    
    # Network configuration
    networks:
      - aineon-network
    
    # Port mappings (localhost)
    ports:
      - "8081:8081"    # Main API
      - "8082:8082"    # Monitoring
      - "8089:8089"    # Dashboard
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    # Environment variables
    environment:
      # Blockchain Configuration
      ETH_RPC_URL: ${ETH_RPC_URL}
      WALLET_ADDRESS: ${WALLET_ADDRESS}
      PRIVATE_KEY: ${PRIVATE_KEY}
      PROFIT_WALLET: ${PROFIT_WALLET:-${WALLET_ADDRESS}}
      
      # API Configuration
      PORT: 8081
      HOST: 0.0.0.0
      
      # Profit Mode Configuration
      ENVIRONMENT: PRODUCTION
      PROFIT_MODE: ENTERPRISE_TIER_0.001%
      AUTO_TRANSFER_ENABLED: "true"
      PROFIT_THRESHOLD_ETH: "5.0"
      MIN_PROFIT_PER_TRADE: "0.5"
      MAX_SLIPPAGE_PCT: "0.001"
      
      # Risk Management
      MAX_POSITION_SIZE: "1000.0"
      DAILY_LOSS_LIMIT: "100.0"
      MAX_DRAWDOWN_PCT: "2.5"
      CIRCUIT_BREAKER: "true"
      
      # Monitoring & Verification
      ETHERSCAN_API_KEY: ${ETHERSCAN_API_KEY}
      ENABLE_PROFIT_AUDIT: "true"
      ENABLE_ETHERSCAN_VERIFICATION: "true"
      
      # Optional: Paymaster (Gasless)
      PAYMASTER_URL: ${PAYMASTER_URL:-https://api.pimlico.io/v2/mainnet/}
      
      # Python Configuration
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      TF_CPP_MIN_LOG_LEVEL: "3"
    
    # Volume mounts
    volumes:
      # Logs volume
      - aineon-logs:/app/logs
      
      # Models cache
      - aineon-models:/app/models
      
      # Data persistence
      - aineon-data:/app/data
      
      # Configuration
      - ./config:/app/config:ro
      
      # Allow dynamic updates
      - ./core:/app/core
    
    # Health check
    healthcheck:
      test: 
        - CMD
        - curl
        - -f
        - http://localhost:8081/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    
    # Logging
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    
    # Dependencies
    depends_on:
      monitoring-service:
        condition: service_started
    
    # Signals for graceful shutdown
    stop_signal: SIGTERM
    stop_grace_period: 30s

  # ============================================================================
  # Monitoring Service (Optional - for enhanced metrics)
  # ============================================================================
  monitoring-service:
    container_name: aineon-monitoring
    image: python:3.11-slim
    build:
      context: .
      dockerfile: Dockerfile.monitoring
    
    networks:
      - aineon-network
    
    ports:
      - "8082:8082"
    
    environment:
      FLASK_ENV: production
      API_HOST: aineon-flashloan
      API_PORT: 8081
    
    depends_on:
      - aineon-flashloan
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 60s
      timeout: 10s
      retries: 3
    
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================

networks:
  aineon-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ============================================================================
# Volumes for Persistence
# ============================================================================

volumes:
  aineon-logs:
    driver: local
  
  aineon-models:
    driver: local
  
  aineon-data:
    driver: local
